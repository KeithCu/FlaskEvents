{% extends "base.html" %}

{% block title %}{% if event %}Edit Event{% else %}New Event{% endif %}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>{% if event %}Edit Event{% else %}New Event{% endif %}</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Quick Date Selector</h5>
                <p class="card-text">Select how many days to add to today's date:</p>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(0)">Today</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(1)">Tomorrow</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(2)">Day After</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(3)">+3 Days</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(7)">Next Week</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <form method="POST" id="eventForm" onsubmit="return validateForm()">
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" name="title" required
                       value="{{ event.title if event else '' }}">
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3">{{ event.description if event else '' }}</textarea>
            </div>
            
            <div class="mb-3">
                <label for="start" class="form-label">Start</label>
                <input type="datetime-local" class="form-control" id="start" name="start" required
                       value="{{ event.start.strftime('%Y-%m-%dT%H:%M') if event else '' }}">
            </div>
            
            <div class="mb-3">
                <label for="end" class="form-label">End</label>
                <input type="datetime-local" class="form-control" id="end" name="end" required
                       value="{{ event.end.strftime('%Y-%m-%dT%H:%M') if event else '' }}">
            </div>
            
            <div class="mb-3">
                <label for="venue_id" class="form-label">Venue <span class="text-danger">*</span></label>
                <div class="d-flex gap-2 align-items-start">
                    <select class="form-control" id="venue_id" name="venue_id" required>
                        <option value="">Select a venue</option>
                        {% for venue in venues %}
                        <option value="{{ venue.id }}" {% if event and event.venue_id == venue.id %}selected{% endif %}>
                            {{ venue.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <a href="{{ url_for('add_venue') }}" class="btn btn-outline-secondary" target="_blank">
                        Add Venue
                    </a>
                </div>
                <div class="invalid-feedback">
                    Please select a venue
                </div>
                <div class="form-text">
                    Don't see the venue you need? <a href="{{ url_for('add_venue') }}" target="_blank">Add a new venue</a> and then refresh this page.
                </div>
            </div>
            
            <!-- Virtual Event Options -->
            <div class="mb-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Event Options</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="is_virtual" name="is_virtual" 
                                   {% if event and event.is_virtual %}checked{% endif %}>
                            <label class="form-check-label" for="is_virtual">
                                <strong>Virtual Event</strong> - This event takes place entirely online
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="is_hybrid" name="is_hybrid" 
                                   {% if event and event.is_hybrid %}checked{% endif %}>
                            <label class="form-check-label" for="is_hybrid">
                                <strong>Hybrid Event</strong> - This event has both in-person and virtual components
                            </label>
                        </div>
                        
                        <div class="mb-3" id="url-section" style="display: none;">
                            <label for="url" class="form-label">Event URL</label>
                            <input type="url" class="form-control" id="url" name="url"
                                   value="{{ event.url if event else '' }}"
                                   placeholder="https://zoom.us/j/123456789, https://facebook.com/events/..., or any event website">
                            <div class="form-text">
                                For virtual events: Zoom, Teams, or other meeting platform URL<br>
                                For in-person events: Facebook event page, event website, or registration link
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="color" class="form-label">Text Color</label>
                <input type="color" class="form-control" id="color" name="color"
                       value="{{ event.color if event else '#3788d8' }}">
            </div>
            
            <div class="mb-3">
                <label for="bg" class="form-label">Background Color</label>
                <input type="color" class="form-control" id="bg" name="bg"
                       value="{{ event.bg if event else '#3788d8' }}">
            </div>
            
            <div class="mb-3">
                <label for="rrule" class="form-label">Recurrence Rule (Optional)</label>
                <input type="text" class="form-control" id="rrule" name="rrule"
                       value="{{ event.rrule if event else '' }}"
                       placeholder="Example: FREQ=WEEKLY;BYDAY=MO,WE,FR">
                <div class="form-text">
                    <strong>Leave empty for one-time events.</strong> Use iCalendar RRULE format for recurring events.<br><br>
                    <strong>Common Examples:</strong><br>
                    • <code>FREQ=WEEKLY;BYDAY=MO</code> - Every Monday<br>
                    • <code>FREQ=MONTHLY;BYDAY=1MO</code> - First Monday of every month<br>
                    • <code>FREQ=YEARLY;BYMONTH=12;BYMONTHDAY=25</code> - December 25th every year<br>
                    • <code>FREQ=WEEKLY;INTERVAL=2</code> - Every other week<br>
                    <strong>Day Codes:</strong> MO=Monday, TU=Tuesday, WE=Wednesday, TH=Thursday, FR=Friday, SA=Saturday, SU=Sunday
                </div>
            </div>
            
            <div class="mb-3" id="recurring-options" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Recurring Event Settings</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="recurring_until" class="form-label">End Date for Recurring Series</label>
                            <input type="date" class="form-control" id="recurring_until" name="recurring_until"
                                   value="{{ event.recurring_until.strftime('%Y-%m-%d') if event and event.recurring_until else '' }}">
                            <div class="form-text">
                                <strong>When should this recurring event series end?</strong><br>
                                • Leave empty for no end date (series continues indefinitely)<br>
                                • Set a specific date to end the series on that date<br>
                                • If no date is set, the series will default to 2 years from the start date
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Save Event</button>
            <a href="{{ url_for('home') }}" class="btn btn-secondary">Cancel</a>
            
            {% if event %}
            <form action="{{ url_for('delete_event', id=event.id) }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this event?')">Delete</button>
            </form>
            {% endif %}
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Set default times when the page loads
document.addEventListener('DOMContentLoaded', function() {
    if (!document.getElementById('start').value) {
        setDateOffset(0);
    }
    
    // Add validation styling to venue select
    const venueSelect = document.getElementById('venue_id');
    venueSelect.addEventListener('change', function() {
        if (this.value === '') {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });
    
    // Handle recurring event options visibility
    const rruleInput = document.getElementById('rrule');
    const recurringOptions = document.getElementById('recurring-options');
    const recurringUntilInput = document.getElementById('recurring_until');
    
    function toggleRecurringOptions() {
        if (rruleInput.value.trim()) {
            recurringOptions.style.display = 'block';
            
            // Set a default end date if none is set (2 years from start date)
            if (!recurringUntilInput.value) {
                const startInput = document.getElementById('start');
                if (startInput.value) {
                    const startDate = new Date(startInput.value);
                    const endDate = new Date(startDate);
                    endDate.setFullYear(startDate.getFullYear() + 2);
                    
                    // Format as YYYY-MM-DD
                    const year = endDate.getFullYear();
                    const month = String(endDate.getMonth() + 1).padStart(2, '0');
                    const day = String(endDate.getDate()).padStart(2, '0');
                    recurringUntilInput.value = `${year}-${month}-${day}`;
                }
            }
        } else {
            recurringOptions.style.display = 'none';
            // Clear the recurring until date when RRULE is cleared
            recurringUntilInput.value = '';
        }
    }
    
    rruleInput.addEventListener('input', toggleRecurringOptions);
    toggleRecurringOptions(); // Initial state
    
    // Update recurring until date when start date changes
    const startInput = document.getElementById('start');
    startInput.addEventListener('change', function() {
        if (rruleInput.value.trim() && !recurringUntilInput.value) {
            // Only update if there's an RRULE and no recurring until date set
            const startDate = new Date(this.value);
            const endDate = new Date(startDate);
            endDate.setFullYear(startDate.getFullYear() + 2);
            
            // Format as YYYY-MM-DD
            const year = endDate.getFullYear();
            const month = String(endDate.getMonth() + 1).padStart(2, '0');
            const day = String(endDate.getDate()).padStart(2, '0');
            recurringUntilInput.value = `${year}-${month}-${day}`;
        }
    });
    
    // Handle virtual event options visibility
    const isVirtualCheckbox = document.getElementById('is_virtual');
    const isHybridCheckbox = document.getElementById('is_hybrid');
    const urlSection = document.getElementById('url-section');
    
    function toggleVirtualOptions() {
        const isVirtual = isVirtualCheckbox.checked;
        const isHybrid = isHybridCheckbox.checked;
        
        if (isVirtual || isHybrid) {
            urlSection.style.display = 'block';
        } else {
            urlSection.style.display = 'none';
        }
    }
    
    isVirtualCheckbox.addEventListener('change', toggleVirtualOptions);
    isHybridCheckbox.addEventListener('change', toggleVirtualOptions);
    toggleVirtualOptions(); // Initial state
});

function validateForm() {
    const venueSelect = document.getElementById('venue_id');
    if (venueSelect.value === '') {
        venueSelect.classList.add('is-invalid');
        return false;
    }
    return true;
}

function setDateOffset(days) {
    const now = new Date();
    const targetDate = new Date(now);
    targetDate.setDate(now.getDate() + days);
    
    // Format date as YYYY-MM-DD
    const year = targetDate.getFullYear();
    const month = String(targetDate.getMonth() + 1).padStart(2, '0');
    const day = String(targetDate.getDate()).padStart(2, '0');
    
    // Set start time to 7 PM
    const startDate = `${year}-${month}-${day}T19:00`;
    document.getElementById('start').value = startDate;
    
    // Set end time to 10 PM
    const endDate = `${year}-${month}-${day}T22:00`;
    document.getElementById('end').value = endDate;
}
</script>
{% endblock %} 