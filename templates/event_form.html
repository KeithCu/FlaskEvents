{% extends "base.html" %}

{% block title %}{% if event %}Edit Event{% else %}New Event{% endif %}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>{% if event %}Edit Event{% else %}New Event{% endif %}</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Quick Date Selector</h5>
                <p class="card-text">Select how many days to add to today's date:</p>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(0)">Today</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(1)">Tomorrow</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(2)">Day After</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(3)">+3 Days</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setDateOffset(7)">Next Week</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <form method="POST" id="eventForm" onsubmit="return validateForm()">
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" name="title" required
                       value="{{ event.title if event else '' }}">
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3">{{ event.description if event else '' }}</textarea>
            </div>
            
            <div class="mb-3">
                <label for="start" class="form-label">Start</label>
                <input type="datetime-local" class="form-control" id="start" name="start" required
                       value="{{ event.start.strftime('%Y-%m-%dT%H:%M') if event else '' }}">
            </div>
            
            <div class="mb-3">
                <label for="end" class="form-label">End</label>
                <input type="datetime-local" class="form-control" id="end" name="end" required
                       value="{{ event.end.strftime('%Y-%m-%dT%H:%M') if event else '' }}">
            </div>
            
            <div class="mb-3">
                <label for="venue_id" class="form-label">Venue <span class="text-danger">*</span></label>
                <select class="form-control" id="venue_id" name="venue_id" required>
                    <option value="">Select a venue</option>
                    {% for venue in venues %}
                    <option value="{{ venue.id }}" {% if event and event.venue_id == venue.id %}selected{% endif %}>
                        {{ venue.name }}
                    </option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback">
                    Please select a venue
                </div>
            </div>
            
            <div class="mb-3">
                <label for="color" class="form-label">Text Color</label>
                <input type="color" class="form-control" id="color" name="color"
                       value="{{ event.color if event else '#3788d8' }}">
            </div>
            
            <div class="mb-3">
                <label for="bg" class="form-label">Background Color</label>
                <input type="color" class="form-control" id="bg" name="bg"
                       value="{{ event.bg if event else '#3788d8' }}">
            </div>
            
            <div class="mb-3">
                <label for="rrule" class="form-label">Recurrence Rule (Optional)</label>
                <input type="text" class="form-control" id="rrule" name="rrule"
                       value="{{ event.rrule if event else '' }}"
                       placeholder="Example: FREQ=WEEKLY;BYDAY=MO,WE,FR">
                <div class="form-text">
                    Leave empty for one-time events. Use iCalendar RRULE format for recurring events.
                </div>
            </div>
            
            <div class="mb-3" id="recurring-options" style="display: none;">
                <label for="recurring_until" class="form-label">Recurring Until</label>
                <input type="date" class="form-control" id="recurring_until" name="recurring_until"
                       value="{{ event.recurring_until.strftime('%Y-%m-%d') if event and event.recurring_until else '' }}">
                <div class="form-text">
                    When should this recurring event series end? Leave empty for no end date.
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Save Event</button>
            <a href="{{ url_for('home') }}" class="btn btn-secondary">Cancel</a>
            
            {% if event %}
            <form action="{{ url_for('delete_event', id=event.id) }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this event?')">Delete</button>
            </form>
            {% endif %}
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Set default times when the page loads
document.addEventListener('DOMContentLoaded', function() {
    if (!document.getElementById('start').value) {
        setDateOffset(0);
    }
    
    // Add validation styling to venue select
    const venueSelect = document.getElementById('venue_id');
    venueSelect.addEventListener('change', function() {
        if (this.value === '') {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });
    
    // Handle recurring event options visibility
    const rruleInput = document.getElementById('rrule');
    const recurringOptions = document.getElementById('recurring-options');
    
    function toggleRecurringOptions() {
        if (rruleInput.value.trim()) {
            recurringOptions.style.display = 'block';
        } else {
            recurringOptions.style.display = 'none';
        }
    }
    
    rruleInput.addEventListener('input', toggleRecurringOptions);
    toggleRecurringOptions(); // Initial state
});

function validateForm() {
    const venueSelect = document.getElementById('venue_id');
    if (venueSelect.value === '') {
        venueSelect.classList.add('is-invalid');
        return false;
    }
    return true;
}

function setDateOffset(days) {
    const now = new Date();
    const targetDate = new Date(now);
    targetDate.setDate(now.getDate() + days);
    
    // Format date as YYYY-MM-DD
    const year = targetDate.getFullYear();
    const month = String(targetDate.getMonth() + 1).padStart(2, '0');
    const day = String(targetDate.getDate()).padStart(2, '0');
    
    // Set start time to 7 PM
    const startDate = `${year}-${month}-${day}T19:00`;
    document.getElementById('start').value = startDate;
    
    // Set end time to 10 PM
    const endDate = `${year}-${month}-${day}T22:00`;
    document.getElementById('end').value = endDate;
}
</script>
{% endblock %} 