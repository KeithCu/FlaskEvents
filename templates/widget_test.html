{% extends "base.html" %}

{% block title %}Widget Test Page{% endblock %}

{% block content %}
<div class="row">
    <!-- Events List Widget -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Events List Widget</h5>
            </div>
            <div class="card-body">
                <div class="events-list-widget">
                    <!-- Add search box -->
                    <div class="search-box mb-3">
                        <input type="text" id="search-input" class="form-control" placeholder="Search events...">
                    </div>
                    <div class="navigation-buttons">
                        <div id="prev-day">¬´ Previous Day</div>
                        <div id="next-day">Next Day ¬ª</div>
                    </div>
                    <div id="selected-date-display" class="mt-3 mb-3"></div>
                    <div id="events-list" class="event-list">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Widget -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Calendar Widget</h5>
            </div>
            <div class="card-body">
                <div id="events-calendar" class="events-calendar-widget"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .event-list {
        margin-top: 20px;
        min-height: 800px;  /* Maintain minimum height */
        opacity: 1;
        transition: opacity 0.2s ease-in-out;
    }
    .event-list.updating {
        opacity: 0;
    }
    .event-item {
        padding: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #3788d8;
        background-color: #f8f9fa;
    }
    .event-time {
        font-weight: bold;
        color: #666;
    }
    .event-title {
        font-size: 1.1em;
        margin: 5px 0;
    }
    .event-description {
        color: #666;
        font-size: 0.9em;
    }
    .event-venue {
        color: #666;
        font-size: 0.9em;
        font-style: italic;
    }
    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 20px;
    }
    .loading {
        text-align: center;
        color: #666;
        padding: 20px;
    }
    #selected-date-display {
        font-weight: bold;
        color: #333;
    }
    .search-box {
        position: relative;
    }
    .search-box input {
        padding-right: 30px;
    }
    .search-box::after {
        content: 'üîç';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }
    
    /* Virtual event styles */
    .badge {
        font-size: 0.75em;
        padding: 0.25em 0.5em;
    }
    
    .btn-sm {
        font-size: 0.875em;
        padding: 0.25rem 0.5rem;
    }
    
    .event-item .btn {
        margin-right: 0.5rem;
        margin-bottom: 0.25rem;
    }
    
    .event-item .btn i {
        margin-right: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add our custom styles after Bootstrap
    const style = document.createElement('style');
    style.textContent = `
        #prev-day, #next-day {
            flex: 1 !important;
            border-radius: 0 !important;
            background-color: #808080 !important;
            border: 1px solid #808080 !important;
            color: white !important;
            padding: 8px 15px !important;
            font-size: 0.9em !important;
            cursor: pointer !important;
            text-align: center !important;
            display: inline-block !important;
            text-decoration: none !important;
            margin: 0 !important;
            line-height: 1.5 !important;
            vertical-align: middle !important;
            user-select: none !important;
        }
        #prev-day:hover, #next-day:hover {
            background-color: #666666 !important;
            border-color: #666666 !important;
            color: white !important;
            text-decoration: none !important;
        }
    `;
    document.head.appendChild(style);

    // Get initial date from URL if available
    const pathParts = window.location.pathname.split('/');
    let initialDate = new Date();
    if (pathParts.length >= 3 && pathParts[1] === 'day') {
        initialDate = new Date(pathParts[2]);
    }

    // Initialize calendar if the element exists
    const calendarEl = document.getElementById('events-calendar');
    if (calendarEl) {
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            initialDate: initialDate,
            headerToolbar: {
                left: 'prev',
                center: 'title',
                right: 'next'
            },
            dateClick: function(info) {
                // Update the events list for the clicked date
                loadEvents(new Date(info.dateStr));
            },
            height: 'auto',
            dayMaxEvents: false,
            nowIndicator: true,
            firstDay: 1,
            locale: 'en'
        });
        
        calendar.render();
    }

    // Initialize events list if the element exists
    const eventsListEl = document.getElementById('events-list');
    const selectedDateDisplayEl = document.getElementById('selected-date-display');
    const searchInput = document.getElementById('search-input');
    if (eventsListEl) {
        const prevDayBtn = document.getElementById('prev-day');
        const nextDayBtn = document.getElementById('next-day');
        let currentDate = initialDate;
        let searchTimeout;

        // Add search functionality
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                loadEvents(currentDate);
                return;
            }

            searchTimeout = setTimeout(() => {
                // Show loading state
                eventsListEl.innerHTML = '<div class="loading">Searching...</div>';
                
                fetch('/search?q=' + encodeURIComponent(query))
                .then(response => response.json())
                .then(events => {
                    if (events.length === 0) {
                        eventsListEl.innerHTML = '<p>No events found matching your search.</p>';
                    } else {
                        const eventsHtml = events.map(event => `
                            <div class="event-item">
                                <div class="event-time">${formatTime(event.start)}</div>
                                <div class="event-title">
                                    ${event.title}
                                    ${event.is_virtual ? '<span class="badge bg-primary ms-2">Virtual</span>' : ''}
                                    ${event.is_hybrid ? '<span class="badge bg-success ms-2">Hybrid</span>' : ''}
                                </div>
                                ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                                ${event.venue ? `<div class="event-venue">at ${event.venue}</div>` : ''}
                                ${event.url ? `
                                    <div class="mt-2">
                                        <a href="${event.url}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="fas fa-external-link-alt"></i> ${event.is_virtual || event.is_hybrid ? 'Join Event' : 'View Details'}
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('');
                        eventsListEl.innerHTML = eventsHtml;
                    }
                })
                .catch(error => {
                    console.error('Error searching events:', error);
                    eventsListEl.innerHTML = '<p>Error searching events. Please try again.</p>';
                });
            }, 300); // Debounce search for 300ms
        });

        function loadEvents(date) {
            const dateStr = date.toISOString().split('T')[0];
            
            // Update the date display
            selectedDateDisplayEl.textContent = formatDateForDisplay(dateStr);
            
            // Create a placeholder with the same height as current content
            const placeholder = document.createElement('div');
            placeholder.style.height = eventsListEl.offsetHeight + 'px';
            placeholder.style.backgroundColor = '#f8f9fa';
            placeholder.style.borderRadius = '4px';
            eventsListEl.innerHTML = '';
            eventsListEl.appendChild(placeholder);

            fetch('/events?date=' + dateStr)
            .then(response => response.json())
            .then(events => {
                if (events.length === 0) {
                    eventsListEl.innerHTML = '<p>No events scheduled for this day.</p>';
                } else {
                    const eventsHtml = events.map(event => `
                        <div class="event-item">
                            <div class="event-time">${formatTime(event.start)}</div>
                            <div class="event-title">
                                ${event.title}
                                ${event.is_virtual ? '<span class="badge bg-primary ms-2">Virtual</span>' : ''}
                                ${event.is_hybrid ? '<span class="badge bg-success ms-2">Hybrid</span>' : ''}
                            </div>
                            ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                            ${event.venue ? `<div class="event-venue">at ${event.venue}</div>` : ''}
                            ${event.url ? `
                                <div class="mt-2">
                                    <a href="${event.url}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="fas fa-external-link-alt"></i> ${event.is_virtual || event.is_hybrid ? 'Join Event' : 'View Details'}
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                    eventsListEl.innerHTML = eventsHtml;
                }
            })
            .catch(error => {
                console.error('Error loading events:', error);
                eventsListEl.innerHTML = '<p>Error loading events. Please try again.</p>';
            });
        }

        function formatTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr);
            const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            return `${dayOfWeek} (${month}-${day}-${year})`;
        }

        function goToPreviousDay() {
            currentDate.setDate(currentDate.getDate() - 1);
            loadEvents(currentDate);
        }

        function goToNextDay() {
            currentDate.setDate(currentDate.getDate() + 1);
            loadEvents(currentDate);
        }

        // Add event listeners
        prevDayBtn.addEventListener('click', goToPreviousDay);
        nextDayBtn.addEventListener('click', goToNextDay);

        // Load initial events
        loadEvents(currentDate);
    }
});
</script>
{% endblock %} 