{% extends "base.html" %}

{% block title %}Daily View - {{ date }}{% endblock %}

{% block extra_css %}
<style>
    #selected-date-display {
        color: red;
        font-weight: bold;
        margin-bottom: 10px;
    }
    #event-list-area h3 { /* Time headings like "11:00 AM" */
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 1.2em; /* From original CSS */
        font-weight: bold;
    }
    #event-list-area p { /* Event item paragraphs */
        margin: 5px 0 5px 20px; /* Indent events under time */
    }
    /* Mini-calendar specific styling */
    #mini-calendar-area * {
        box-sizing: border-box !important;
    }
    
    #mini-calendar-area {
        max-width: 200px !important;
        width: 200px !important;
    }
    
    #mini-calendar-area .fc {
        font-size: 9px !important;
        line-height: 1 !important;
    }
    
    #mini-calendar-area .fc-header-toolbar {
        background-color: white !important;
        color: black !important;
        padding: 0 !important;
        margin: 0 !important;
        font-size: 9px !important;
        height: 16px !important;
        min-height: 16px !important;
    }
    
    #mini-calendar-area .fc-header-toolbar .fc-button {
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6 !important;
        color: #212529 !important;
        box-shadow: none !important;
        padding: 0 1px !important;
        font-size: 9px !important;
        height: 14px !important;
        line-height: 12px !important;
        margin: 0 !important;
    }
    
    #mini-calendar-area .fc-daygrid-day {
        height: 14px !important;
        min-height: 14px !important;
        max-height: 14px !important;
    }
    
    #mini-calendar-area .fc-daygrid-day-number {
        font-size: 9px !important;
        padding: 0 !important;
        line-height: 14px !important;
        height: 14px !important;
    }
    
    #mini-calendar-area .fc-col-header-cell {
        padding: 0 !important;
        height: 14px !important;
        min-height: 14px !important;
        max-height: 14px !important;
    }
    
    #mini-calendar-area .fc-col-header-cell-cushion {
        font-size: 9px !important;
        padding: 0 !important;
        line-height: 14px !important;
        height: 14px !important;
    }
    
    #mini-calendar-area .fc-daygrid-body {
        width: 100% !important;
    }
    
    #mini-calendar-area .fc-scrollgrid {
        border: none !important;
    }
    
    #mini-calendar-area .fc-scrollgrid-section > * {
        border: none !important;
    }
    
    #mini-calendar-area .fc-toolbar-title {
        font-size: 10px !important;
        line-height: 16px !important;
        height: 16px !important;
    }
    
    #mini-calendar-area .fc-daygrid-day-frame {
        padding: 0 !important;
        height: 14px !important;
        min-height: 14px !important;
        max-height: 14px !important;
    }
    
    #mini-calendar-area .fc-view-harness {
        height: auto !important;
    }
    
    #mini-calendar-area .fc-daygrid-view {
        height: auto !important;
    }
    
    /* Debug styles to verify our CSS is being applied */
    #mini-calendar-area {
        border: 2px solid red !important;
    }
    
    #mini-calendar-area .fc-header-toolbar {
        border: 2px solid blue !important;
    }
    
    #mini-calendar-area .fc-daygrid-day {
        border: 1px solid green !important;
    }
    .navigation-buttons {
        margin-top: 20px;
    }
    .event-link, .venue-link {
        color: red;
        text-decoration: none;
    }
    .venue-link {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 id="selected-date-display"></h2>
    <p>Click red arrow (‚Üê) for event info : Click venue name for venue details</p>

    <div class="row">
        <div class="col-md-7" id="event-list-area">
            </div>
        <div class="col-md-5">
            <div id="mini-calendar-area"></div>
        </div>
    </div>

    <div class="text-center navigation-buttons">
        <button id="prev-day" class="btn btn-primary">Previous Day</button>
        <button id="next-day" class="btn btn-primary">Next Day</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{# FullCalendar v6 is loaded from base.html, no need for v5 links here #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var miniCalendarEl = document.getElementById('mini-calendar-area');
    var currentDate = '{{ date }}'; // Initial date from Flask
    var eventListEl = document.getElementById('event-list-area');
    var selectedDateDisplayEl = document.getElementById('selected-date-display');

    var miniCalendar = new FullCalendar.Calendar(miniCalendarEl, {
        initialView: 'dayGridMonth',
        initialDate: currentDate,
        headerToolbar: {
            left: 'prev',
            center: 'title',
            right: 'next'
        },
        selectable: true,
        dateClick: function(info) {
            navigateToDate(info.dateStr);
        },
        dayHeaderFormat: { weekday: 'narrow' },
        height: 'auto',
        contentHeight: 'auto',
        aspectRatio: 3,
        dayMaxEvents: false,
        nowIndicator: true,
        firstDay: 1,
        locale: 'en',
        width: '200px'
    });
    
    miniCalendar.render();
    
    // Force calendar to update its size
    setTimeout(() => {
        miniCalendar.updateSize();
    }, 100);

    miniCalendar.select(currentDate); // Visually select the current date on the mini-calendar

    // Initialize the page display
    updateCurrentPageDisplay(currentDate);

    function navigateToDate(dateStr) {
        // Update URL and reload page for the new date.
        // This uses the existing Flask route '/day/<date>'
        window.location.href = '/day/' + dateStr;
    }

    function updateCurrentPageDisplay(dateStr) {
        currentDate = dateStr;
        selectedDateDisplayEl.innerText = formatDateForDisplay(currentDate);
        fetchEventsForDay(currentDate);
        // The mini-calendar's date is already set by initialDate or will be correct on page load
        // but ensure it's selected if the page was navigated to by other means.
        miniCalendar.gotoDate(currentDate); // Ensure the calendar view shifts if month changes
        miniCalendar.select(currentDate);
    }

    function fetchEventsForDay(dateStr) {
        fetch('/events?date=' + dateStr)
        .then(response => response.json())
        .then(events => {
            if (events.length === 0) {
                eventListEl.innerHTML = '<p>No events scheduled for this day.</p>';
                return;
            }

            const eventsHtml = events.map(event => `
                <div class="event-item">
                    <div class="event-time">${formatTime(event.start)}</div>
                    <div class="event-title">${event.title}</div>
                    ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                    ${event.venue ? `<div class="event-venue">at ${event.venue}</div>` : ''}
                </div>
            `).join('');

            eventListEl.innerHTML = eventsHtml;
        })
        .catch(error => {
            console.error('Error loading events:', error);
            eventListEl.innerHTML = '<p>Error loading events. Please try again.</p>';
        });
    }

    document.getElementById('prev-day').addEventListener('click', function() {
        var dateObj = new Date(currentDate + 'T00:00:00Z'); // Parse as UTC then operate
        dateObj.setUTCDate(dateObj.getUTCDate() - 1);
        navigateToDate(dateObj.toISOString().split('T')[0]);
    });

    document.getElementById('next-day').addEventListener('click', function() { //
        var dateObj = new Date(currentDate + 'T00:00:00Z'); // Parse as UTC then operate
        dateObj.setUTCDate(dateObj.getUTCDate() + 1);
        navigateToDate(dateObj.toISOString().split('T')[0]);
    });

    function formatDateForDisplay(dateStr) {
        var date = new Date(dateStr + 'T00:00:00Z');
        var dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long', timeZone: 'UTC' });
        var month = String(date.getUTCMonth() + 1).padStart(2, '0');
        var day = String(date.getUTCDate()).padStart(2, '0');
        var year = String(date.getUTCFullYear()).slice(-2);
        return `${dayOfWeek} (${month}-${day}-${year})`;
    }

    function formatTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
        });
    }
});
</script>
{% endblock %}